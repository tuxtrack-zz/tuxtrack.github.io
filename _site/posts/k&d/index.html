<!DOCTYPE html><html lang="en" mode="dark" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Kerberos & Delegation | TUXTRACK</title><meta name="generator" content="Jekyll v4.0.1" /><meta property="og:title" content="Kerberos &amp; Delegation" /><meta name="author" content="tuxtrack" /><meta property="og:locale" content="en_US" /><meta name="description" content="Dando continuidade aos posts relacionados ao kerberos, nesse blog post falaremos sobre Kerberos Delegation. Delegation é usado para resolver o problema de quando um serviço necessita acessar outro serviço em um computador diferente. Esse cenário é conhecido como “Double Hop Problem”." /><meta property="og:description" content="Dando continuidade aos posts relacionados ao kerberos, nesse blog post falaremos sobre Kerberos Delegation. Delegation é usado para resolver o problema de quando um serviço necessita acessar outro serviço em um computador diferente. Esse cenário é conhecido como “Double Hop Problem”." /><link rel="canonical" href="http://localhost:4000/posts/k&d/" /><meta property="og:url" content="http://localhost:4000/posts/k&d/" /><meta property="og:site_name" content="TUXTRACK" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-05-09T13:00:00-03:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Kerberos &amp; Delegation" /><meta name="twitter:site" content="@tuxtrack" /><meta name="twitter:creator" content="@tuxtrack" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"datePublished":"2020-05-09T13:00:00-03:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/posts/k&d/"},"url":"http://localhost:4000/posts/k&d/","author":{"@type":"Person","name":"tuxtrack"},"description":"Dando continuidade aos posts relacionados ao kerberos, nesse blog post falaremos sobre Kerberos Delegation. Delegation é usado para resolver o problema de quando um serviço necessita acessar outro serviço em um computador diferente. Esse cenário é conhecido como “Double Hop Problem”.","headline":"Kerberos &amp; Delegation","dateModified":"2020-05-09T13:00:00-03:00","@type":"BlogPosting","@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" as="style" href="/assets/css/main.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/main.css"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script> window.jQuery || document.write('<script src="/assets/lib/jquery-3.4.1.min.js"><\/script>'); </script> <script src="https://cdn.jsdelivr.net/npm/popper.js@1.15.0/dist/umd/popper.min.js" integrity="sha256-fTuUgtT7O2rqoImwjrhDgbXTKUwyxxujIMRIK7TbuNU=" crossorigin="anonymous" async></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha256-5+02zu5UULQkO7w1GIr6vftCgMfFdZcAHeDtFnKZsBs=" crossorigin="anonymous" async></script> <script src="/assets/js/dist/commons.js" async></script> <script src="/assets/js/dist/timeago.min.js" async></script><link rel="preload" as="style" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/syntax.css"><link rel="stylesheet" href="/assets/css/post.css"><link rel="stylesheet" href="/assets/css/syntax.css"> <script src="/assets/js/dist/tooltip-loader.min.js" async></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/" alt="avatar"> <img src="/assets/img/sample/avatar.jpg" alt="avatar"> </a></div><div class="profile-text mt-3"><div id="site-title"> <a href="/">TUXTRACK</a></div><div id="site-subtitle" class="font-italic">Hacking stuff directly from sertão</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-3 mr-3 unloaded"></i> <span>BLOG</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-3 mr-3 unloaded"></i> <span>ARCHIVES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/tabs/about/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-info ml-3 mr-3 unloaded"></i> <span>ABOUT ME</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <a href="https://github.com/tuxtrack" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="https://instagram.com/tuxtrack" target="_blank"> <i class="fab fa-instagram"></i> </a> <a href="https://twitter.com/tuxtrack" target="_blank"> <i class="fab fa-twitter"></i> </a> <a href="javascript:window.open('mailto:' + ['tuxtrack','hacknroll.com'].join('@'))"> <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" target="_blank"> <i class="fas fa-rss"></i> </a></div></div><div id="main-wrapper"><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Kerberos & Delegation</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago" data-toggle="tooltip" data-placement="bottom" title="Sat, May 9, 2020, 1:00 PM -0300"> May 9, 2020 <i class="unloaded">2020-05-09T13:00:00-03:00</i> </span></div></div><div class="post-content"><p>Dando continuidade aos posts relacionados ao kerberos, nesse blog post falaremos sobre Kerberos Delegation. Delegation é usado para resolver o problema de quando um serviço necessita acessar outro serviço em um computador diferente. Esse cenário é conhecido como “Double Hop Problem”.</p><p><img class="lozad" src= /assets/img/commons/loading.png data-src="/assets/img/sample/k&amp;d/2hop.png" alt="upload-image" /></p><p>Para trazer para o lado prático da coisa, imagine que inicialmente comprometemos uma máquina e estabelecemos acesso a mesma via <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_pssessions?view=powershell-7">PSSession</a> utilizando-se do WinRM service. A partir dessa sessão estabelecida, tentamos acessar algum recurso em outra máquina pertecente ao mesmo domínio. O resultado dessa tentativa de acesso ao recurso será a negação da mesma. Isso por conta do modo como o kerberos encaminha os TGT’s para a autenticação e validação das contas de usuário.</p><p><img class="lozad" src= /assets/img/commons/loading.png data-src="/assets/img/sample/k&amp;d/psfail.png" alt="upload-image" /></p><p>Levando em consideração que possuímos permissões de acesso, em uma sessão PSSession estaremos utilizando o logon type 3, <a href="https://docs.microsoft.com/pt-br/windows-server/security/windows-authentication/windows-logon-scenarios#network-logon">Network Logon</a>. O usuário irá receber o token de logon com Network Logon Type e nenhuma credencial será enviada ao host de destino nem solicitada devido a prévia checagem de autorização (<a href="https://docs.microsoft.com/pt-br/windows-server/security/kerberos/kerberos-authentication-overview#practical-applications">SSO</a>). Sendo assim, não há credenciais para serem reutilizadas quando a partir do host de destino, tentarmos acessar o recurso no host alvo.</p><table><thead><tr><th style="text-align: left">Logon Type<th style="text-align: left">Logon title<th>Description<tbody><tr><td style="text-align: left">2<td style="text-align: left">Interactive<td>A user logged on to this computer<tr><td style="text-align: left">3<td style="text-align: left">Network<td>A user or computer logged on to this computer from the network<tr><td style="text-align: left">5<td style="text-align: left">Service<td>A service was started by the Service Control Manager.<tr><td style="text-align: left">8<td style="text-align: left">NetworkCleartext<td>A user logged on to this computer from the network. The user’s password was passed to the authentication package in its unhashed form.</table><p><img class="lozad" src= /assets/img/commons/loading.png data-src="/assets/img/sample/k&amp;d/event.png" alt="upload-image" /></p><p>Para resolver o problema, a Microsoft implementou um rescurso chamado Delegation. Primeiramente implementado no Windows Server 2000 através da forma conhecida como Unconstrained Delegation, a configuração sofreu algumas alterações sendo implementado a opção Constrained a partir da versão do Windows Server 2003 e Resource Based Delegation em 2016. Delegation é a permissão para um usuário ou computador de <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc961980(v=technet.10)?redirectedfrom=MSDN">personificar</a> outra conta, resolvendo assim o Double Hop Problem, onde o token personificado será reutilizado para uma nova autenticação.</p><h2 id="unconstrained-delegation">Unconstrained Delegation</h2><p>Ao ser atribuído Unconstrained Delegation ao computador/conta, significa que o(a) mesma poderá personificar qualquer usuário do domínio. Assim, o mesmo computador/conta poderá acessar o recurso solicitado, reutilizando suas credenciais.</p><p><img class="lozad" src= /assets/img/commons/loading.png data-src="/assets/img/sample/k&amp;d/undelegation.png" alt="upload-image" /></p><p>Ao ser solicitado o acesso a um recurso através de um computador com constrained delegation habilitado, um atacante poderá abusar do fato do token poder ser reutilizado para acessar qualquer recurso na rede, já que no modo Unconstrained o administrador de sistema não especifica o recurso que poderá reutilizar as credenciais.</p><p><img class="lozad" src= /assets/img/commons/loading.png data-src="/assets/img/sample/k&amp;d/unconstrained.png" alt="upload-image" /></p><p>Como exemplo imagine que</p><h2 id="constrained-delegation">Constrained Delegation</h2><p><img class="lozad" src= /assets/img/commons/loading.png data-src="/assets/img/sample/k&amp;d/constrained.png" alt="upload-image" /></p><h2 id="rbcd---resource-based-constrained-delegation">RBCD - Resource Based Constrained Delegation</h2><h2 id="quem-pode-delegar-como-enumerar">Quem Pode Delegar? Como enumerar?</h2></div><div class="post-tail-wrapper text-muted"><div class="pt-3"> <a href="/tags/active-directory/" class="post-tag no-text-decoration" >ACTIVE DIRECTORY</a> <a href="/tags/redteam/" class="post-tag no-text-decoration" >REDTEAM</a> <a href="/tags/windows/" class="post-tag no-text-decoration" >WINDOWS</a> <a href="/tags/delegation/" class="post-tag no-text-decoration" >DELEGATION</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center pt-5 pb-2"> <!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label ml-1 mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Kerberos & Delegation - TUXTRACK&url=http://localhost:4000/posts/k&d/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Kerberos & Delegation - TUXTRACK&u=http://localhost:4000/posts/k&d/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Kerberos & Delegation - TUXTRACK&url=http://localhost:4000/posts/k&d/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div></div><div class="row"><div id="post-extend-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- The Disqus lazy loading. Powered by: https://osvaldas.info/lazy-loading-disqus-comments v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung MIT License --><div id="disqus" class="pt-2 pb-4"><p class="font-italic text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script src="/assets/lib/jquery.disqusloader.min.js"></script> <script> var options = { scriptUrl: '//tuxtrack.disqus.com/embed.js', disqusConfig: function() { this.page.url = 'http://localhost:4000/posts/k&d/'; this.page.identifier = '/posts/k&d/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const observer = lozad(); observer.observe(); </script></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted"></h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js" integrity="sha256-qcLR00zq6pJk4je3MLgAri8Nn+ZumUlXgTKR2H/xCY0=" crossorigin="anonymous"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="http://localhost:4000{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
